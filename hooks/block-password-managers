#!/bin/bash
# PreToolUse hook: blocks ALL access to password manager data, CLIs, and processes
# Exit 0 = allow, Exit 2 = block with message on stderr
#
# Protects: 1Password, Bitwarden, macOS Keychain
# Covers: Bash commands, Read tool, Edit tool, Write tool, Glob tool

INPUT=$(cat)
TOOL=$(echo "$INPUT" | jq -r '.tool_name // empty')

# === BASH COMMAND BLOCKS ===
if [ "$TOOL" = "Bash" ]; then
  CMD=$(echo "$INPUT" | jq -r '.tool_input.command // empty')

  # --- PASSWORD MANAGER CLIs ---
  if echo "$CMD" | grep -qE '(^|\s|&&|\||;)\s*(op|bw)\s'; then
    echo "BLOCKED: password manager CLI (op/bw) — vault access not allowed" >&2
    exit 2
  fi

  # --- macOS KEYCHAIN ACCESS ---
  if echo "$CMD" | grep -qE 'security\s+(find-generic-password|find-internet-password|dump-keychain|delete-keychain|export|find-certificate)'; then
    echo "BLOCKED: macOS Keychain access — credential extraction not allowed" >&2
    exit 2
  fi

  # --- PASSWORD MANAGER DATA DIRECTORIES ---
  if echo "$CMD" | grep -qiE '(cat|head|tail|less|more|bat|cp|mv|tar|zip|rsync|scp|strings|xxd|hexdump|sqlite3|plutil|defaults\s+read).*(1Password|1password|bitwarden)'; then
    echo "BLOCKED: reading password manager data files" >&2
    exit 2
  fi

  # --- PASSWORD MANAGER PROCESS MANIPULATION ---
  if echo "$CMD" | grep -qiE '(kill|killall|pkill)\s.*(1Password|1password|bitwarden)'; then
    echo "BLOCKED: cannot kill password manager processes" >&2
    exit 2
  fi

  # --- 1PASSWORD AGENT SOCKET ---
  if echo "$CMD" | grep -qE '\.1password/(agent|identit)'; then
    echo "BLOCKED: 1Password agent/identity access" >&2
    exit 2
  fi

  # --- KEYCHAIN FILE DIRECT ACCESS ---
  if echo "$CMD" | grep -qiE '(cat|head|tail|less|more|bat|cp|strings|sqlite3|hexdump).*\.(keychain|keychain-db)'; then
    echo "BLOCKED: direct keychain file access" >&2
    exit 2
  fi

  # --- BROWSER EXTENSION DATA (password manager vaults cache here) ---
  if echo "$CMD" | grep -qiE '(cat|head|tail|cp|strings|sqlite3).*(2BUA8C4S2C|com\.1password|com\.bitwarden)'; then
    echo "BLOCKED: password manager browser extension data access" >&2
    exit 2
  fi

  exit 0
fi

# === READ / EDIT / WRITE / GLOB TOOL BLOCKS ===
# These tools access files directly, bypassing Bash
if [ "$TOOL" = "Read" ] || [ "$TOOL" = "Edit" ] || [ "$TOOL" = "Write" ]; then
  FILE_PATH=$(echo "$INPUT" | jq -r '.tool_input.file_path // empty')

  if echo "$FILE_PATH" | grep -qiE '1Password|1password|\.1password'; then
    echo "BLOCKED: cannot access 1Password data — $FILE_PATH" >&2
    exit 2
  fi

  if echo "$FILE_PATH" | grep -qiE 'bitwarden|com\.bitwarden'; then
    echo "BLOCKED: cannot access Bitwarden data — $FILE_PATH" >&2
    exit 2
  fi

  if echo "$FILE_PATH" | grep -qiE '\.keychain|\.keychain-db|Keychains/'; then
    echo "BLOCKED: cannot access macOS Keychain files — $FILE_PATH" >&2
    exit 2
  fi

  if echo "$FILE_PATH" | grep -qiE '2BUA8C4S2C'; then
    echo "BLOCKED: cannot access 1Password browser helper data — $FILE_PATH" >&2
    exit 2
  fi

  exit 0
fi

# === GLOB TOOL BLOCKS (prevents directory scanning) ===
if [ "$TOOL" = "Glob" ]; then
  PATTERN=$(echo "$INPUT" | jq -r '.tool_input.pattern // empty')
  GLOB_PATH=$(echo "$INPUT" | jq -r '.tool_input.path // empty')

  if echo "$PATTERN$GLOB_PATH" | grep -qiE '1Password|1password|\.1password|bitwarden|com\.bitwarden|keychain|2BUA8C4S2C'; then
    echo "BLOCKED: cannot scan password manager directories" >&2
    exit 2
  fi

  exit 0
fi

# All other tools: allow
exit 0
