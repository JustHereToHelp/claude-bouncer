#!/bin/bash
# PreToolUse hook: blocks access to sensitive system directories
# Exit 0 = allow, Exit 2 = block with message on stderr
# Shows macOS dialog for override. Logs all decisions.
#
# Protects: Browser credential stores, SSH/GPG keys, personal comms,
# dev auth tokens, system auth files
# Covers: Bash commands, Read tool, Edit tool, Write tool, Glob tool

INPUT=$(cat)
TOOL=$(echo "$INPUT" | jq -r '.tool_name // empty')

# --- LOGGING ---
LOG_DIR="$HOME/.claude_bouncer"
LOG_FILE="$LOG_DIR/audit.log"
LOCK_FILE="$LOG_DIR/dialog.lock"
SESSION_DIR="$LOG_DIR/sessions"
SESSION_FILE="$SESSION_DIR/$PPID.trusted"
mkdir -p "$LOG_DIR" "$SESSION_DIR"

# Clean up stale session files (parent PID no longer running)
for f in "$SESSION_DIR"/*.trusted; do
  [ -e "$f" ] || continue
  pid=$(basename "$f" .trusted)
  if ! kill -0 "$pid" 2>/dev/null; then
    rm -f "$f"
  fi
done

log_event() {
  local decision="$1" reason="$2" detail="$3"
  local ts
  ts=$(date '+%Y-%m-%dT%H:%M:%S%z')
  printf '[%s] %s tool=%s reason="%s" detail="%s"\n' \
    "$ts" "$decision" "$TOOL" "$reason" "${detail:0:500}" >> "$LOG_FILE"
}

# --- SANITIZE for AppleScript ---
sanitize() {
  local s="$1"
  s="${s//\\/\\\\}"
  s="${s//\"/\\\"}"
  s="${s//$'\n'/\\n}"
  s="${s//$'\r'/}"
  echo "$s"
}

# --- PROMPT FUNCTION ---
prompt_override() {
  local reason="$1" detail="$2"

  # Check session trust
  if [ -f "$SESSION_FILE" ] && grep -qxF "$reason" "$SESSION_FILE"; then
    log_event "SESSION_TRUSTED" "$reason" "$detail"
    return 0
  fi

  local reason_safe detail_safe
  reason_safe=$(sanitize "$reason")
  detail_safe=$(sanitize "${detail:0:300}")

  if ! mkdir "$LOCK_FILE" 2>/dev/null; then
    log_event "BLOCKED_LOCKED" "$reason" "$detail"
    echo "BLOCKED (dialog locked): $reason" >&2
    return 2
  fi
  trap 'rmdir "$LOCK_FILE" 2>/dev/null' EXIT

  local result
  result=$(osascript -e "
    set theChoice to button returned of (display dialog \"⚠️ Claude Bouncer\" & return & return & \"Blocked: ${reason_safe}\" & return & return & \"Detail:\" & return & \"${detail_safe}\" buttons {\"Block\", \"Allow Once\", \"Trust Session\"} default button \"Block\" with title \"Claude Bouncer\" with icon caution giving up after 120)
    return theChoice
  " 2>/dev/null)

  rmdir "$LOCK_FILE" 2>/dev/null
  trap - EXIT

  if [ "$result" = "Trust Session" ]; then
    echo "$reason" >> "$SESSION_FILE"
    log_event "TRUSTED_SESSION" "$reason" "$detail"
    return 0
  elif [ "$result" = "Allow Once" ]; then
    log_event "ALLOWED_ONCE" "$reason" "$detail"
    return 0
  else
    log_event "BLOCKED" "$reason" "$detail"
    echo "BLOCKED (user denied): $reason" >&2
    return 2
  fi
}

# === BASH COMMAND BLOCKS ===
if [ "$TOOL" = "Bash" ]; then
  CMD=$(echo "$INPUT" | jq -r '.tool_input.command // empty')

  # --- BROWSER CREDENTIAL STORES ---
  if echo "$CMD" | grep -qiE '(cat|head|tail|less|more|bat|cp|mv|tar|zip|rsync|strings|xxd|hexdump|sqlite3).*(Chrome|BraveSoftware|Microsoft.Edge|Opera|Vivaldi)'; then
    prompt_override "browser credential/cookie database access" "${CMD:0:200}"
    exit $?
  fi

  if echo "$CMD" | grep -qiE '(cat|head|tail|less|cp|strings|sqlite3).*Firefox/Profiles'; then
    prompt_override "Firefox profile data access" "${CMD:0:200}"
    exit $?
  fi

  if echo "$CMD" | grep -qiE '(cat|head|tail|less|cp|strings|sqlite3).*Library/Safari'; then
    prompt_override "Safari data access" "${CMD:0:200}"
    exit $?
  fi

  if echo "$CMD" | grep -qiE '(cat|head|tail|less|cp|strings|sqlite3).*Library/Cookies'; then
    prompt_override "system cookie store access" "${CMD:0:200}"
    exit $?
  fi

  # --- GPG KEYS ---
  if echo "$CMD" | grep -qiE '(cat|head|tail|less|more|bat|cp|mv|tar|strings).*\.gnupg'; then
    prompt_override "GPG keyring access" "${CMD:0:200}"
    exit $?
  fi

  # --- PERSONAL COMMUNICATIONS ---
  if echo "$CMD" | grep -qiE '(cat|head|tail|less|cp|strings|sqlite3|tar|zip).*Library/Messages'; then
    prompt_override "iMessage/SMS history access" "${CMD:0:200}"
    exit $?
  fi

  if echo "$CMD" | grep -qiE '(cat|head|tail|less|cp|strings|sqlite3|tar|zip).*Library/Mail'; then
    prompt_override "Apple Mail data access" "${CMD:0:200}"
    exit $?
  fi

  # --- DEV AUTH TOKENS ---
  if echo "$CMD" | grep -qiE '(cat|head|tail|less|more|bat|cp).*\.config/gh/hosts'; then
    prompt_override "GitHub CLI token access" "${CMD:0:200}"
    exit $?
  fi

  if echo "$CMD" | grep -qiE '(cat|head|tail|less|more|bat|cp).*\.docker/config\.json'; then
    prompt_override "Docker credential access" "${CMD:0:200}"
    exit $?
  fi

  if echo "$CMD" | grep -qiE '(cat|head|tail|less|more|bat|cp).*\.kube/config'; then
    prompt_override "Kubernetes credential access" "${CMD:0:200}"
    exit $?
  fi

  if echo "$CMD" | grep -qiE '(cat|head|tail|less|more|bat|cp).*\.npmrc'; then
    prompt_override "npm auth token access" "${CMD:0:200}"
    exit $?
  fi

  # --- SYSTEM AUTH ---
  if echo "$CMD" | grep -qiE '(cat|head|tail|less|more|bat|vi|nano|sed).*(/etc/sudoers|/etc/pam\.d/)'; then
    prompt_override "system auth config access" "${CMD:0:200}"
    exit $?
  fi

  exit 0
fi

# === READ / EDIT / WRITE TOOL BLOCKS ===
if [ "$TOOL" = "Read" ] || [ "$TOOL" = "Edit" ] || [ "$TOOL" = "Write" ]; then
  FILE_PATH=$(echo "$INPUT" | jq -r '.tool_input.file_path // empty')

  if echo "$FILE_PATH" | grep -qiE '\.ssh/(id_|authorized_keys|known_hosts|config)'; then
    prompt_override "SSH keys/config access" "$FILE_PATH"
    exit $?
  fi

  if echo "$FILE_PATH" | grep -qiE '\.gnupg/'; then
    prompt_override "GPG keyring access" "$FILE_PATH"
    exit $?
  fi

  if echo "$FILE_PATH" | grep -qiE '(Google/Chrome|BraveSoftware|Microsoft Edge|Opera|Vivaldi).*(Login Data|Cookies|Web Data)'; then
    prompt_override "browser credential store access" "$FILE_PATH"
    exit $?
  fi
  if echo "$FILE_PATH" | grep -qiE 'Firefox/Profiles.*(key[0-9]\.db|logins\.json|cookies\.sqlite|cert[0-9]\.db)'; then
    prompt_override "Firefox credentials access" "$FILE_PATH"
    exit $?
  fi
  if echo "$FILE_PATH" | grep -qiE 'Library/Safari'; then
    prompt_override "Safari data access" "$FILE_PATH"
    exit $?
  fi
  if echo "$FILE_PATH" | grep -qiE 'Library/Cookies'; then
    prompt_override "system cookies access" "$FILE_PATH"
    exit $?
  fi

  if echo "$FILE_PATH" | grep -qiE 'Library/Messages'; then
    prompt_override "iMessage/SMS data access" "$FILE_PATH"
    exit $?
  fi
  if echo "$FILE_PATH" | grep -qiE 'Library/Mail'; then
    prompt_override "Apple Mail data access" "$FILE_PATH"
    exit $?
  fi

  if echo "$FILE_PATH" | grep -qiE '\.config/gh/hosts'; then
    prompt_override "GitHub CLI tokens access" "$FILE_PATH"
    exit $?
  fi
  if echo "$FILE_PATH" | grep -qiE '\.docker/config\.json'; then
    prompt_override "Docker credentials access" "$FILE_PATH"
    exit $?
  fi
  if echo "$FILE_PATH" | grep -qiE '\.kube/config'; then
    prompt_override "Kubernetes credentials access" "$FILE_PATH"
    exit $?
  fi
  if echo "$FILE_PATH" | grep -qiE '(^|/)\.npmrc$'; then
    prompt_override "npm auth tokens access" "$FILE_PATH"
    exit $?
  fi

  if echo "$FILE_PATH" | grep -qiE '^/etc/(sudoers|pam\.d/)'; then
    prompt_override "system auth config access" "$FILE_PATH"
    exit $?
  fi

  exit 0
fi

# === GLOB TOOL BLOCKS ===
if [ "$TOOL" = "Glob" ]; then
  PATTERN=$(echo "$INPUT" | jq -r '.tool_input.pattern // empty')
  GLOB_PATH=$(echo "$INPUT" | jq -r '.tool_input.path // empty')
  COMBINED="$PATTERN$GLOB_PATH"

  if echo "$COMBINED" | grep -qiE '\.ssh'; then
    prompt_override "scanning SSH directory" "$COMBINED"
    exit $?
  fi
  if echo "$COMBINED" | grep -qiE '\.gnupg'; then
    prompt_override "scanning GPG directory" "$COMBINED"
    exit $?
  fi
  if echo "$COMBINED" | grep -qiE '(Chrome|BraveSoftware|Microsoft.Edge|Firefox/Profiles|Library/Safari|Library/Cookies)'; then
    prompt_override "scanning browser data directories" "$COMBINED"
    exit $?
  fi
  if echo "$COMBINED" | grep -qiE 'Library/(Messages|Mail)'; then
    prompt_override "scanning personal communications" "$COMBINED"
    exit $?
  fi
  if echo "$COMBINED" | grep -qiE '\.config/gh|\.docker|\.kube'; then
    prompt_override "scanning dev auth directories" "$COMBINED"
    exit $?
  fi

  exit 0
fi

# All other tools: allow
exit 0
